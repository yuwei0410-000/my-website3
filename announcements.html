<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“¢ æœ€æ–°å…¬å‘Š</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .announcement-container {
      max-width: 800px;
      margin: 30px auto;
      padding: 20px;
    }

    .announcement {
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #fafafa;
      padding: 15px;
      margin-bottom: 15px;
    }

    .announcement h3 {
      margin-top: 0;
    }

    .announcement small {
      display: block;
      color: #666;
      margin-top: 8px;
    }

    #searchInput {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      font-size: 16px;
    }

    #addBtn {
      display: none;
      text-align: right;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <nav>
		<a href="index.html">ğŸ  é¦–é </a>
		<a href="announcements.html">ğŸ“¢ æœ€æ–°å…¬å‘Š</a>
		<a href="course.html">ğŸ“˜ èª²ç¨‹ç·´ç¿’</a>
		<a href="review.html">ğŸ† å€‹äººæˆæœ</a>
		<a href="admin.html">ğŸ“Š æˆç¸¾æª¢è¦–</a>
		<a href="profile.html">âš™ï¸ è¨­å®š</a>
	</nav>
  <main class="announcement-container">
    <h1>ğŸ“¢ æœ€æ–°å…¬å‘Š</h1>
    <div id="addBtn">
      <a href="announcement_admin.html"><button>âœï¸ æ–°å¢å…¬å‘Šï¼ˆåƒ…é™æ•™å¸«ï¼‰</button></a>
    </div>
    <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹æ¨™é¡Œæˆ–å…§å®¹é—œéµå­—..." />
    <div id="announcementList">å…¬å‘Šè¼‰å…¥ä¸­...</div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDTfQ0US5aQqwg6rmBAF8SGew6a0MMMmaY",
      authDomain: "s11155037-chimo.firebaseapp.com",
      databaseURL: "https://s11155037-chimo-default-rtdb.firebaseio.com",
      projectId: "s11155037-chimo"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const announcementList = document.getElementById("announcementList");
    const searchInput = document.getElementById("searchInput");
    const addBtn = document.getElementById("addBtn");

    let allAnnouncements = [];
    let userRole = null;

    function renderAnnouncements(data, keyword = "") {
      announcementList.innerHTML = "";

      const filtered = data.filter(a =>
        (a.title || "").toLowerCase().includes(keyword.toLowerCase()) ||
        (a.content || "").toLowerCase().includes(keyword.toLowerCase())
      );

      if (filtered.length === 0) {
        announcementList.textContent = "â— æ²’æœ‰ç¬¦åˆæœå°‹çš„å…¬å‘Šã€‚";
        return;
      }

      filtered.forEach(a => {
        const div = document.createElement("div");
        div.className = "announcement";

        const header = document.createElement("h3");
        header.textContent = a.title;

        const meta = document.createElement("small");
        meta.textContent = `ğŸ“… ${new Date(a.timestamp).toLocaleString()}ï½œğŸ‘¤ ${a.author}`;

        const contentFull = document.createElement("div");
        contentFull.textContent = a.content;
        contentFull.style.marginTop = "8px";

        div.appendChild(header);
        div.appendChild(meta);
        div.appendChild(contentFull);

        // æ•™å¸«å°ˆç”¨æŒ‰éˆ•
        if (userRole === "teacher") {
          const editBtn = document.createElement("button");
          editBtn.textContent = "âœï¸ ç·¨è¼¯";
          editBtn.style.marginRight = "10px";
          editBtn.onclick = () => {
            window.location.href = `announcement_edit.html?id=${a.id}`;
          };

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "ğŸ—‘ï¸ åˆªé™¤";
          deleteBtn.onclick = () => {
            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å‰‡å…¬å‘Šå—ï¼Ÿ")) {
              remove(ref(db, `announcements/${a.id}`)).then(() => {
                alert("âœ… å·²åˆªé™¤å…¬å‘Š");
                location.reload();
              }).catch(err => {
                alert("âŒ åˆªé™¤å¤±æ•—ï¼š" + err.message);
              });
            }
          };

          const btnBox = document.createElement("div");
          btnBox.style.marginTop = "10px";
          btnBox.appendChild(editBtn);
          btnBox.appendChild(deleteBtn);
          div.appendChild(btnBox);
        }

        announcementList.appendChild(div);
      });
    }

    // ç™»å…¥å¾Œå†è¼‰å…¥è³‡æ–™
    onAuthStateChanged(auth, (user) => {
      if (!user) return;

      get(ref(db, `users/${user.uid}/profile`)).then(snap => {
        if (snap.exists()) {
          const profile = snap.val();
          userRole = profile.role;
          if (userRole === "teacher") {
            addBtn.style.display = "block";
          }
        }

        // ç­‰èº«ä»½ç¢ºå®šå¾Œå†è¼‰å…¥å…¬å‘Š
        get(ref(db, "announcements")).then(snapshot => {
          if (!snapshot.exists()) {
            announcementList.textContent = "â— ç›®å‰å°šç„¡å…¬å‘Šã€‚";
            return;
          }

          allAnnouncements = [];
          snapshot.forEach(child => {
            const data = child.val();
            data.id = child.key;
            allAnnouncements.push(data);
          });

          allAnnouncements.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
          renderAnnouncements(allAnnouncements);
        });
      });
    });

    // æœå°‹ç›£è½
    searchInput.addEventListener("input", () => {
      renderAnnouncements(allAnnouncements, searchInput.value);
    });
  </script>
</body>
</html>
